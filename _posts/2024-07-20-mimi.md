---
layout: post
title: "Mimi: The Codec behind Moshi and Unmute"
date: 2024-07-20 09:00:00-0400
description: A deep dive into Kyutai's state-of-the-art neural audio codec, exploring its architecture, quantization, and integration with LLMs.
tags: audio ai deep-learning codecs
categories: technology
related_posts: false
---

![Mimi architecture diagram](../img/mimi_arch.avif)

[Official Paper](https://kyutai.org/Moshi.pdf) for reference. Minimal environment setup to use Mimi can be found [in my repo](https://github.com/iliasslasri/mimi).

## The Scope of this Post

Today we are going to explore Mimi, a state-of-the-art neural audio codec developed by Kyutai. We will compare audio quality before and after Mimi processing, and we will then study how Mimi works and what types of outputs it produces.

## What is Mimi?

> "Mimi codec is a state-of-the-art audio neural codec, developed by Kyutai, that combines semantic and acoustic information into audio tokens running at 12Hz and a bitrate of 1.1kbps."

This is the official description of Mimi from Kyutai's Huggingface repo. Mimi is also the neural audio codec that powers Moshi (a demo is currently available on [moshi.chat](https://moshi.chat)), which we may discuss in a future post.

## What is a Neural Audio Codec?

First, let's define a codec: A codec, short for "coder-decoder" or "compressor-decompressor", is a device or computer program that encodes or decodes a digital data stream or signal.

The primary purposes of codecs are to:
* Reduce file size for efficient storage
* Decrease bandwidth requirements for transmission
* Maintain an acceptable level of quality

An audio codec is a codec that encodes or decodes audio data. There exist two types of audio codecs:
* **Lossy audio codecs:** These compress audio by removing some data, resulting in smaller file sizes but with some loss in quality (e.g., MP3, AAC).
* **Lossless audio codecs:** These compress audio without losing any original data, maintaining perfect quality but with larger file sizes compared to lossy codecs (e.g., FLAC, ALAC).

A neural audio codec is a type of audio codec that leverages DNNs, neural networks in particular, to compress and decompress audio signals. Some examples include:
* **Lyra:** Developed by Google, designed for low-bitrate speech compression.
* **EnCodec:** Created by Meta AI, a high-fidelity neural audio codec.
* **SoundStream:** Another Google codec focusing on high-quality audio compression at low bitrates.



Mimi's architecture is mostly derived from SoundStream and EnCodec, as stated in the [official paper](https://kyutai.org/Moshi.pdf), although it has some novel features that set it apart.

## Mimi in Detail

As mentioned earlier, Mimi is a neural audio codec that combines semantic and acoustic information into audio tokens running at 12Hz and a bitrate of 1.1kbps.

However, there is a slight discrepancy: the actual implementation of Mimi runs at **12.5Hz**, as stated in the paper and in the official `config.json` file (under `frame_rate`). Apart from that, Mimi is a fascinating codec that produces high-quality audio at an incredibly low bitrate.

Being an audio codec, Mimi is composed of two main components which form a bottleneck architecture:
1.  **An encoder:** Takes an audio signal as input and compresses it into a smaller representation.
2.  **A decoder:** Takes the compressed representation and reconstructs the audio signal.

### The Encoding Process

The encoder compresses the audio signal into a sequence of audio codes, split into semantic and acoustic audio tokens. Here's how it works:

* The audio signal is split into frames, each lasting 0.08 seconds (12.5Hz frame rate).
* Each frame is passed through a convolutional neural network (CNN) and a transformer, which convert the frame into a vector of length 512.
* This vector is then passed through 8 quantizers.



These quantizers produce 1 token per frame each:
* **1 quantizer** for the semantic tokens. These represent the content/meaning of the audio and are trained to replicate semantic information obtained from a WavLM self-supervised audio model.
* **7 quantizers** (according to the paper) for the acoustic tokens, which capture the style and details of the audio.

The quantized audio tokens are concatenated to produce a tensor of shape `(batch_size, num_quantizers, sample_rate * length_audio)`.

### Bitrate Calculation

Let's calculate the bitrate of Mimi based on the information provided using the following parameters:

* Frame rate: $$12.5 \text{ Hz}$$
* Number of audio tokens per frame: $$8$$
* Number of bits per audio token: $$\log_2(2048) = 11$$ (since there are 2048 possible audio tokens)

Therefore, the bitrate calculation is:

$$
12.5 \times 8 \times 11 = 1100 \text{ bps} \text{ (or } 1.1 \text{ kbps)}
$$

*Note: Here we find another discrepancy. The paper states that there are 8 audio tokens per frame, but the official implementation produces 32 audio tokens per frame, and we can even set the number of levels in RQV as specified in [issue #122](https://github.com/kyutai-labs/moshi/issues/122).*

### The Decoding Process

The decoder takes the quantized tokens and reconstructs the audio signal following these steps:
1.  The tokens are passed through an inverse quantization process.
2.  The resulting embeddings are processed by another transformer network.
3.  Finally, a decoder CNN (mirroring the encoder's CNN) reconstructs the audio waveform.

## Applications of Mimi

Mimi was primarily developed to power **Moshi**, a speech-to-speech AI model.

Current chat models (like GPT) primarily operate on text tokensâ€”discrete numerical representations of words. These models aren't inherently designed to process audio data. Mimi bridges this gap by converting audio into discrete tokens, similar to how text is tokenized.



This clever approach allows text-only models to support audio understanding and generation without requiring a complete overhaul of their architecture. Theoretically, we could fine-tune existing text-trained models to work with audio by teaching them to interpret these audio tokens alongside text tokens.

## Conclusions

Mimi represents a significant step forward in the field of neural audio codecs. Its ability to compress audio to incredibly low bitrates while maintaining good quality is impressive. The separation of semantic and acoustic information into distinct tokens is a novel approach that opens up new possibilities for audio processing.

Using RQV is also a novel approach for quantization in codecs; check this for an implementation of RQV in [PyTorch](https://github.com/lucidrains/vector-quantize-pytorch).